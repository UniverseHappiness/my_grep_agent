# 高级CLI交互模式使用指南

## 🎯 概述

高级CLI模式使用 `prompt_toolkit` 库提供专业的命令行交互体验，支持：

- ✅ **方向键支持**：⬆️⬇️ 浏览历史命令，⬅️➡️ 移动光标编辑
- ✅ **自动补全**：按Tab键补全命令
- ✅ **智能建议**：根据历史自动推荐命令
- ✅ **完整编辑**：支持删除、剪切、粘贴等所有标准编辑操作
- ✅ **历史记录**：自动保存命令历史
- ✅ **友好界面**：彩色输出和格式化显示

## 📦 安装依赖

首先安装新增的依赖库：

```bash
# 安装prompt_toolkit
pip install prompt_toolkit>=3.0.0

# 或者重新安装所有依赖
pip install -r requirements.txt
```

## 🚀 启动方式

### 方式1：使用run.py（默认高级模式）

```bash
python run.py
```

### 方式2：使用python -m运行

```bash
# 高级模式（推荐）
python -m grep_agent --mode advanced

# 或简写
python -m grep_agent -m advanced

# 其他模式
python -m grep_agent -m enhanced  # 增强版（旧版）
python -m grep_agent -m cli       # 基础CLI
python -m grep_agent -m api       # API服务
```

### 方式3：指定配置文件

```bash
python -m grep_agent -m advanced -c config/config.yaml
```

## ⌨️ 键盘快捷键

### 导航和编辑

| 快捷键 | 功能 | 说明 |
|--------|------|------|
| ⬆️ | 上一条历史命令 | 浏览之前输入的命令 |
| ⬇️ | 下一条历史命令 | 向下浏览命令历史 |
| ⬅️ | 光标左移 | 向左移动一个字符 |
| ➡️ | 光标右移 | 向右移动一个字符 |
| Home / Ctrl+A | 移到行首 | 快速跳到开头 |
| End / Ctrl+E | 移到行尾 | 快速跳到结尾 |
| Ctrl+⬅️ | 左移一个单词 | 按单词跳转 |
| Ctrl+➡️ | 右移一个单词 | 按单词跳转 |

### 删除和编辑

| 快捷键 | 功能 | 说明 |
|--------|------|------|
| Backspace | 删除前一个字符 | 标准删除 |
| Delete | 删除后一个字符 | 向前删除 |
| Ctrl+W | 删除前一个单词 | 快速删除单词 |
| Ctrl+K | 删除到行尾 | 清除后面内容 |
| Ctrl+U | 删除到行首 | 清除前面内容 |
| Ctrl+L | 清屏 | 清除屏幕（部分终端） |

### 补全和建议

| 快捷键 | 功能 | 说明 |
|--------|------|------|
| Tab | 自动补全 | 补全命令 |
| ➡️ | 接受建议 | 接受灰色提示文本 |

### 控制操作

| 快捷键 | 功能 | 说明 |
|--------|------|------|
| Enter | 执行命令 | 提交输入 |
| Ctrl+C | 取消操作 | 中断当前操作 |
| Ctrl+D | 退出程序 | EOF信号 |

## 📋 命令列表

### 基本命令

| 命令 | 说明 | 示例 |
|------|------|------|
| help | 显示帮助信息 | `help` |
| examples | 查看搜索示例 | `examples` |
| config list | 查看当前配置 | `config list` |
| history | 查看搜索历史 | `history` |
| clear | 清屏 | `clear` |
| exit / quit | 退出程序 | `exit` |

### 搜索查询

直接输入你的问题，例如：
- `查找所有Python文件`
- `统计代码总行数`
- `查找包含TODO的代码`
- `查看README文件内容`

## 🎨 界面特性

### 彩色输出

- 🟢 **绿色**：成功消息和提示符
- 🔵 **蓝色**：信息提示
- 🟡 **黄色**：警告信息
- 🔴 **红色**：错误消息
- 🟣 **紫色**：标题和重要信息
- ⚪ **灰色**：次要信息和建议

### 格式化显示

- 📝 输入提示：带表情符号的友好提示
- 📊 结果展示：清晰的表格和分隔线
- 📜 命令历史：带序号的历史记录
- ✅ 状态标识：直观的完成/失败标记

## 💡 使用技巧

### 1. 历史命令快速访问

按 ⬆️ 键可以快速浏览之前执行过的命令，找到后直接按Enter即可重新执行。

### 2. 自动补全

输入命令的开头几个字母后按Tab，系统会自动补全：
```
he<Tab>  → help
ex<Tab>  → examples
co<Tab>  → config list
```

### 3. 智能建议

开始输入时，会出现灰色的建议文本（基于历史命令），按 ➡️ 键接受建议。

### 4. 快速编辑

- 使用 Ctrl+A 跳到开头，Ctrl+E 跳到结尾
- 使用 Ctrl+W 快速删除错误的单词
- 使用 Ctrl+K 清除后面的内容

### 5. 查看历史

输入 `history` 命令可以查看最近10次搜索记录，包括查询、状态和结果预览。

## 📝 使用示例

### 基本搜索流程

```
$ python run.py

🔍 Grep搜索Agent - 高级交互模式
=====================================

✨ 功能特性：
  ✅ 支持方向键：⬆️⬇️ 浏览历史命令，⬅️➡️ 移动光标编辑
  ✅ 自动补全：按Tab键补全命令
  ✅ 智能建议：根据历史自动推荐
  ✅ LLM自动生成Linux命令
  ✅ 完整的命令执行历史

💡 提示：输入 'help' 查看帮助，'examples' 查看示例

📝 搜索查询 (输入help查看帮助): 查找所有Python文件
🔍 搜索范围: ./src
🔢 最大命令执行次数: 5
⚠️  是否需要确认每个命令（y/n）: n

======================================================================
🚀 开始智能搜索
======================================================================
📝 查询: 查找所有Python文件
📁 范围: ./src
🔢 最大次数: 5
⚠️  确认模式: 否
======================================================================

[执行搜索过程...]

======================================================================
📊 搜索完成
======================================================================
🏷️  会话ID: abc123...
📍 状态: ✅ 已完成
🔄 执行轮次: 2/5
⏱️  总耗时: 1.23秒
======================================================================

📜 命令执行历史：

  1. 命令: find ./src -name '*.py' -type f
     目的: 查找所有Python文件
     结果: 25行，耗时0.15秒

======================================================================
✅ 最终答案：

找到25个Python文件：
./src/grep_agent/__init__.py
./src/grep_agent/core/agent.py
...

======================================================================
```

### 使用历史命令

```
📝 搜索查询: [按⬆️键，自动填入之前的命令]
📝 搜索查询: 查找所有Python文件  [上一次的命令]
```

### 命令补全

```
📝 搜索查询: he[按Tab]
📝 搜索查询: help  [自动补全]
```

### 快速编辑

```
📝 搜索查询: 查找所有Pytho文件  [输入错误]
[按⬅️移动光标到'o'和'文'之间，按Delete删除'o'，输入'on']
📝 搜索查询: 查找所有Python文件  [修正完成]
```

## 🆚 与其他模式对比

| 特性 | 高级模式 (advanced) | 增强模式 (enhanced) | 基础模式 (cli) |
|------|---------------------|---------------------|----------------|
| 方向键浏览历史 | ✅ | ❌ | ❌ |
| 光标左右移动 | ✅ | ❌ | ❌ |
| Tab补全 | ✅ | ❌ | ❌ |
| 智能建议 | ✅ | ❌ | ❌ |
| 彩色输出 | ✅ | ✅ | ⚠️ 部分 |
| 历史记录 | ✅ | ❌ | ❌ |
| LLM生成命令 | ✅ | ✅ | ❌ |
| 完整编辑功能 | ✅ | ❌ | ❌ |

**推荐**：优先使用 `advanced` 模式，体验最佳！

## 🐛 故障排除

### 问题1：方向键显示乱码

**原因**：终端不支持或prompt_toolkit未正确安装

**解决**：
```bash
# 重新安装prompt_toolkit
pip install --upgrade prompt_toolkit

# 或使用增强模式
python -m grep_agent -m enhanced
```

### 问题2：历史记录不保存

**说明**：当前使用内存历史（InMemoryHistory），程序退出后不保存。

**未来改进**：可以改用FileHistory持久化保存。

### 问题3：彩色不显示

**原因**：某些终端不支持彩色

**解决**：使用支持ANSI颜色的终端（大多数现代终端都支持）

### 问题4：Tab补全没反应

**检查**：
1. 确认已输入命令的开头字母
2. 只能补全预定义的命令（help、exit、examples等）
3. 自定义查询不需要补全

## 📚 相关文档

- [README.md](README.md) - 项目概览
- [QUICKSTART.md](QUICKSTART.md) - 快速开始
- [ENHANCED_FEATURES.md](ENHANCED_FEATURES.md) - 增强功能说明
- [COMMAND_VALIDATION_FIX.md](COMMAND_VALIDATION_FIX.md) - 命令验证修复说明

## 🎉 总结

高级CLI模式提供了最佳的命令行交互体验：

- ✅ **直观**：方向键、删除键都符合预期行为
- ✅ **高效**：历史、补全、建议提升输入速度
- ✅ **友好**：彩色界面和清晰的提示
- ✅ **强大**：保持所有LLM智能搜索功能

现在就开始使用吧！

```bash
python run.py
```

祝使用愉快！🚀
